<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ottawa Sailing Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#005599" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <!-- Version 1.1, JS Version 1.1. Last build Sept 15, 2025. Build 2 -->
  
  <!-- Leaflet -->
  <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
-->

<!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <style>
    :root { --topbar-h: 0px; } /* JS sets this to header+nav total height */

    /* Base */
    html, body { margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f0f0f0; color: #111; }
    img, iframe { display: block; max-width: 100%; height: auto; border: 0; }
    a { color: #003366; text-decoration: none; font-weight: 600; }
    a:hover { text-decoration: underline; }

    /* Top bar */
    header { background: #003366; color: #fff; text-align: center; padding: 1em; }
    nav {
      display: flex; justify-content: center; gap: 0;
      background: #005599; overflow-x: auto; white-space: nowrap;
    }
    /* Make header + nav always clickable above everything */
    header, nav { position: sticky; top: 0; z-index: 5001; }

    nav button {
      appearance: none; background: none; border: 0; color: #fff;
      padding: 1em 1.2em; font-size: 1rem; cursor: pointer; flex: 0 0 auto;
    }
    nav button:hover, nav button.active { background: #0077aa; }
    nav button:focus-visible { outline: 2px solid #fff; outline-offset: -2px; }

    /* Tabs */
    .tab-content {
      display: none; padding: 1em; background: #fff;
      max-width: 1000px; margin: 0.75em auto; box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    .tab-content.active { display: block; }

    /* Map Tab */
    #map.tab-content { max-width: none; padding: 0; box-shadow: none; margin: 0; }
    #leaflet-map { width: 100%; height: 78vh; }

    /* Floating controls panel (click-safe below header/nav) */
    .leaflet-ctrl {
      position: fixed; z-index: 3000;  /* below header/nav (5001) */
      right: 12px; top: calc(var(--topbar-h) + 12px);
      width: 220px; background: rgba(255,255,255,.94);
      border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.12);
      overflow: hidden; pointer-events: auto;
    }
    .leaflet-ctrl * { pointer-events: auto; }
    /* Hide panel completely when map tab is hidden so it never intercepts clicks */
    #map.tab-content:not(.active) .leaflet-ctrl { display: none !important; }

    .ctrl-header {
      display: flex; align-items: center; gap: 8px; padding: 8px 10px;
      background: #0a2946; color: #fff; cursor: pointer; user-select: none;
    }
    .ctrl-header .speed { font-size: 1.6rem; font-weight: 800; letter-spacing: .5px; margin-left: auto; }
    .ctrl-header .units { font-size: .9rem; opacity: .9; margin-left: 4px; }
    .ctrl-header .chev { width: 18px; height: 18px; transition: transform .2s; }
    .leaflet-ctrl.collapsed .chev { transform: rotate(-90deg); }

    .ctrl-body { padding: 8px 10px; display: grid; gap: 6px; }
    .ctrl-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .ctrl-body button, .ctrl-body select, .ctrl-body label { font: inherit; }
    .ctrl-body button, .ctrl-body select {
      padding: 8px; border: 1px solid #d0d7de; border-radius: 8px; background: #fff;
    }
    .ctrl-body label { display: flex; align-items: center; gap: 8px; }
    .tiny-note { font-size: 12px; opacity: .8; }

    /* Compass */
    .compass { position: relative; width: 28px; height: 28px; border-radius: 50%; background: #fff; border: 2px solid #d0d7de; }
    .compass .needle {
      position: absolute; left: 50%; top: 50%; width: 2px; height: 12px; background: #d00;
      transform-origin: 50% 90%; transform: translate(-50%,-90%) rotate(0deg);
    }
    .compass .tail {
      position: absolute; left: 50%; top: 50%; width: 2px; height: 8px; background: #333;
      transform-origin: 50% -10%; transform: translate(-50%,-10%) rotate(180deg);
    }
    .compass .north { position: absolute; top: 2px; left: 50%; transform: translateX(-50%); font-size: 9px; color: #333; }

    /* Boat marker */
    
    /* Old boat marker (Leaflet)
    .boat { width: 40px; height: 40px; margin-left: -20px; margin-top: -20px; filter: drop-shadow(0 0 3px rgba(0,0,0,.5)); }
    .boat svg { width: 40px; height: 40px; }
    */
    
    /* MapLibre marker is anchored at element center; remove Leaflet-era offsets.
       Shift up ~17px so the bow tip sits on the coordinate. */
    .boat {
      width: 40px; height: 40px;
      margin: 0;
      filter: drop-shadow(0 0 3px rgba(0,0,0,.5));
      transform: translateY(-17px);
      pointer-events: none; /* don't steal map clicks */
    }
    .boat svg { width: 40px; height: 40px; }
    .boat .hull { fill: #003b8e; stroke: #ffffff; stroke-width: 3; }
    .boat .mast { stroke: #ffffff; stroke-width: 5; stroke-linecap: round; }

    /* Collapsed panel shows only header */
    .leaflet-ctrl.collapsed .ctrl-body { display: none; }

    /* Collapsibles (Info tab) */
    .collapsible-container {
      max-width: 700px; margin: 2em auto; background: #fff; border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1); overflow: hidden;
    }
    .collapsible {
      width: 100%; background: #005599; color: #fff; cursor: pointer;
      padding: 1em; border: 0; text-align: left; font-size: 1.1em; font-weight: 700;
    }
    .collapsible:hover, .collapsible.active { background: #0077aa; }
    .collapsible-content { display: none; padding: 1em; background: #fff; }

    /* Mobile tweaks */
    @media (max-width: 600px) {
      header { font-size: 1rem; }
      nav button { font-size: .95rem; padding: .75em 1em; }
      .tab-content { padding: .8em; margin: .5em auto; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Ottawa River Sailing Dashboard</h1>
  </header>

  <nav aria-label="Primary">
    <button type="button" class="active" data-tab="forecast" aria-controls="forecast" aria-selected="true">Forecast</button>
    <button type="button" data-tab="radar" aria-controls="radar">Radar</button>
    <button type="button" data-tab="map" aria-controls="map">Marine Map</button>
    <button type="button" data-tab="info" aria-controls="info">Info</button>
    <button type="button" data-tab="emergency" aria-controls="emergency">Emergency</button>
  </nav>

  <!-- Forecast Tab -->
  <section id="forecast" class="tab-content active" role="region" aria-labelledby="forecast-tab">
    <div id="windguru-hooks"></div>

    <!-- Windguru widgets (unchanged) -->
    <script id="wg_fwdg_91822_100_1754791053518">
      (function (window, document) {
        var loader = function () {
          var arg = ["s=91822","m=100","uid=wg_fwdg_91822_100_1754791053518","wj=knots","tj=c","waj=ft","tij=ft","odh=0","doh=24","fhours=240","hrsm=2","vt=forecasts","lng=en","idbs=1","p=WINDSPD,GUST,SMER,TMPE,FLHGT,CDC,APCP1s,RATING"];
          var script = document.createElement("script");
          var tag = document.getElementsByTagName("script")[0];
          script.src = "https://www.windguru.cz/js/widget.php?" + arg.join("&");
          tag.parentNode.insertBefore(script, tag);
        };
        window.addEventListener ? window.addEventListener("load", loader, false) : window.attachEvent("onload", loader);
      })(window, document);
    </script>
    <script id="wg_fwdg_91822_3_1754791112083">
      (function (window, document) {
        var loader = function () {
          var arg = ["s=91822","m=3","uid=wg_fwdg_91822_3_1754791112083","wj=knots","tj=c","waj=ft","tij=ft","odh=0","doh=24","fhours=240","hrsm=3","vt=forecasts","lng=en","p=WINDSPD,GUST,MWINDSPD,SMER,TMPE,FLHGT,CDC,APCP1s,RATING"];
          var script = document.createElement("script");
          var tag = document.getElementsByTagName("script")[0];
          script.src = "https://www.windguru.cz/js/widget.php?" + arg.join("&");
          tag.parentNode.insertBefore(script, tag);
        };
        window.addEventListener ? window.addEventListener("load", loader, false) : window.attachEvent("onload", loader);
      })(window, document);
    </script>

    <script src="https://www.windfinder.com/widget/forecast/js/nepean-sailing-club_graham-bay?unit_wave=ft&unit_rain=mm&unit_temperature=c&unit_wind=kts&unit_pressure=hPa&days=4&show_day=0&show_waves=0"></script>
    <noscript>
      <a rel="nofollow noopener noreferrer" target="_blank"
         href="https://www.windfinder.com/forecast/nepean-sailing-club_graham-bay?utm_source=forecast&utm_medium=web&utm_campaign=homepageweather&utm_content=noscript-forecast">
         Wind forecast for Nepean Sailing Club
      </a> provided by
      <a rel="nofollow noopener noreferrer" target="_blank"
         href="https://www.windfinder.com?utm_source=forecast&utm_medium=web&utm_campaign=homepageweather&utm_content=noscript-logo">
         windfinder.com
      </a>
    </noscript>

    <iframe
      src="https://widgets.sailflow.com/widgets/web/conditions?spot_id=896&units_wind=kts&units_temp=C&width=300&height=600&color=0A2946&name=Ottawa&activity=Sail&app=sailflow"
      width="300" height="600" title="Sailflow Conditions"></iframe>

    <a href="https://weather.gc.ca/en/location/index.html?coords=45.403,-75.687" target="_blank" rel="noopener noreferrer">Environment Canada Forecast</a>
    <iframe title="Environment Canada Weather" width="296" height="191" src="https://weather.gc.ca/wxlink/wxlink.html?coords=45.403%2C-75.687&lang=e"></iframe>
    <a class="weatherwidget-io" href="https://forecast7.com/en/45d42n75d69/ottawa/" data-label_1="OTTAWA" data-label_2="WEATHER" data-theme="pure">OTTAWA WEATHER</a>
  </section>

  <!-- Radar Tab -->
  <section id="radar" class="tab-content" role="region" aria-labelledby="radar-tab">
    <h2 style="text-align:center;">🌦️ Live Radar & Conditions</h2>
    <iframe
      src="https://www.meteoblue.com/en/weather/maps/widget/ottawa_canada_6094817?windAnimation=1&gust=1&satellite=1&cloudsAndPrecipitation=1&temperature=1&sunshine=1&extremeForecastIndex=1&geoloc=fixed&tempunit=C&windunit=kn&lengthunit=metric&zoom=10&autowidth=auto"
      style="width: 100%; height: 720px;" title="Meteoblue Radar"></iframe>
    <div style="text-align: center;">
      <a href="https://www.meteoblue.com/en/weather/maps/ottawa_canada_6094817" target="_blank" rel="noopener noreferrer">View full Meteoblue map</a>
    </div>
  </section>

  <!-- Marine Map Tab -->
  <section id="map" class="tab-content" role="region" aria-labelledby="map-tab">
    <div id="leaflet-map" aria-label="Marine Map"></div>

    <!-- Floating controls -->
    <div class="leaflet-ctrl collapsed" id="mm-panel">
      <div class="ctrl-header" id="mm-toggle" aria-expanded="false">
        <div class="compass" title="Heading">
          <div class="north">N</div>
          <div class="needle" id="mm-needle"></div>
          <div class="tail"></div>
        </div>
        <div class="speed"><span id="mm-speed">—</span><span class="units"> kn</span></div>
        <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <path d="M8 10l4 4 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="ctrl-body">
        <div style="font-weight:700;">GPS</div>
        <div class="ctrl-row">
          <button id="mm-startgps" type="button">Start GPS</button>
          <button id="mm-recenter" type="button">Recenter</button>
        </div>

        <div class="ctrl-row">
          <label><input type="checkbox" id="mm-follow" checked> Follow</label>
          <label><input type="checkbox" id="mm-courseup"> Course-up</label>
        </div>

        <div id="mm-gps-status" class="tiny-note" aria-live="polite"></div>

        <hr>

        <div style="font-weight:700;">Markers</div>
        <div class="ctrl-row">
          <select id="mm-marker-type">
            <option value="warn">🔴 Warning</option>
            <option value="fish">🟢 Fish</option>
            <option value="other">🟡 Other</option>
          </select>
          <button id="mm-drop-marker" type="button">Drop marker</button>
        </div>
        <div class="tiny-note">Tap the map to place when active.</div>

        <hr>

        <div class="ctrl-row">
          <button id="mm-snapnorth" type="button">Snap North</button>
          <button id="mm-resettrail" type="button">Reset Trail</button>
        </div>
        <button id="mm-exportgpx" type="button">Export GPX</button>

        <div id="mm-stats" class="tiny-note" style="margin-top:6px;"></div>
      </div>
    </div>
  </section>

  <!-- Info Tab -->
  <section id="info" class="tab-content" role="region" aria-labelledby="info-tab">
    <a href="pos.jpg" target="_blank" rel="noopener noreferrer"><img src="pos.jpg" alt="Position Reference" width="800" /></a>

    <div id="manual-water-widget" style="max-width: 500px; margin: 2em auto; padding: 1em; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center;">
      <h2>💧 Ottawa River Water Level – Britannia</h2>
      <p>Chart Datum: <strong>57.9 m MASL</strong></p>
      <label for="levelInput">Enter Current Water Level (m):</label>
      <input type="number" id="levelInput" step="0.1" placeholder="e.g. 58.3" value="57.9" style="padding: 0.75em; font-size: 1.2em; width: 180px; text-align: center;">
      <button id="calc-offset" type="button">Calculate</button>
      <div id="offsetResult" style="margin-top: 1em;"></div>
      <p><a href="https://wateroffice.ec.gc.ca/report/real_time_e.html?stn=02KF005" target="_blank" rel="noopener noreferrer">Environment Canada – Britannia Station</a></p>
    </div>

    <div id="gps-widget" style="max-width: 500px; margin: 2em auto; padding: 1em; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center;">
      <h2>📍 Your GPS Location</h2>
      <p id="gps-output">Checking location…</p>
      <div id="gps-map-link" style="margin-top: 1em;"></div>
    </div>

    <div style="padding: 1em;">
      <h2 style="text-align: center;">Rules of the Road</h2>
      <a href="rotr.jpg" target="_blank" rel="noopener noreferrer"><img src="rotr.jpg" alt="Rules of the Road"></a>
      <ul>
        <li><b>Rule 1:</b> Same tack → leeward has right-of-way.</li>
        <li><b>Rule 2:</b> Opposite tacks → starboard tack has right-of-way.</li>
        <li><b>Rule 3:</b> Overtaking: boat ahead (overtaken) has right-of-way.</li>
        <li><b>Note:</b> Starboard tack: wind coming from starboard side.</li>
      </ul>
    </div>

  <!-- Anchoring Checklist -->
  <div class="collapsible-container">
    <button class="collapsible">⚓ Anchoring Checklist</button>
    <div class="collapsible-content">
      <h3>✅ Before Anchoring</h3>
      <ul>
        <li>Check wind & current direction</li>
        <li>Choose a spot with room to swing</li>
        <li>Confirm depth and bottom type</li>
        <li>Calculate scope: 5:1 (calm), 7:1+ (windy)</li>
        <li>Prepare anchor, rode, chain</li>
        <li>Assign hand signals or radio contact</li>
      </ul>
      <h3>⚓ While Anchoring</h3>
      <ul>
        <li>Approach slowly, head into wind/current</li>
        <li>Stop boat — let it drift back</li>
        <li>Lower anchor (don’t throw)</li>
        <li>Pay out rode while reversing gently</li>
        <li>Set anchor: reverse until tension</li>
        <li>Check for drag visually or via GPS</li>
      </ul>
      <h3>🔒 After Anchoring</h3>
      <ul>
        <li>Snub the line with cleat or snubber</li>
        <li>Set anchor alarm if using GPS</li>
        <li>Check reference points</li>
        <li>Log GPS position</li>
        <li>Stow remaining rode</li>
      </ul>
    </div>
  </div>

  <!-- Cast-Off Procedure -->
  <div class="collapsible-container">
    <button class="collapsible">🚤 Cast-Off Procedure (Backing Out of Slip)</button>
    <div class="collapsible-content">
      <h3>✅ Before Casting Off</h3>
      <ul>
        <li>Engine running in neutral</li>
        <li>Check surroundings</li>
        <li>Rudder centered</li>
        <li>Disconnect shore power</li>
        <li>Fenders secured</li>
      </ul>
      <h3>🪢 Line Handling (Suggested Order)</h3>
      <ol>
        <li><strong>Bow line</strong> — release first</li>
        <li><strong>Spring line</strong> — release second</li>
        <li><strong>Stern line</strong> — release last</li>
      </ol>
      <h3>🕹️ Backing Out</h3>
      <ul>
        <li>Engage reverse idle</li>
        <li>Release bow and spring lines as you begin moving</li>
        <li>Release stern line and steer away</li>
        <li>Use short reverse bursts for control</li>
        <li>Shift to forward gear once clear</li>
      </ul>
      <h3>🔁 Tips</h3>
      <ul>
        <li>Use stern spring line to pivot if needed</li>
        <li>Account for wind pushing bow or stern</li>
        <li>Use prop walk or rudder thrust creatively</li>
      </ul>
    </div>
  </div>
  <!-- end collapsible -->
  



    <div style="padding: 1em;">
      <h2 style="text-align: center;">Sail Reference Info</h2>
      <ul>
        <li>VHF Channel 16 – Emergency / Hailing</li>
        <li>Anchoring: 5:1–7:1+ scope</li>
        <li>Prevailing winds: WNW → NW</li>
        <li>Marina: <a href="https://nsc.ca" target="_blank" rel="noopener noreferrer">Nepean Sailing Club</a></li>
      </ul>
    </div>
  </section>

  <!-- Emergency Tab -->
  <section id="emergency" class="tab-content" role="region" aria-labelledby="emergency-tab">
    <!-- …your emergency content… -->
   <!-- Emergency Tab -->

  <div style="padding: 1em;">
    <h2 style="text-align: center;">🆘 Emergency Information</h2>

    <h3>⛴️ How to Call for Help on the Water</h3>

    <h4>Marine VHF Radio (Preferred)</h4>
    <ol>
      <li>Switch to <strong>Channel 16</strong></li>
      <li>Clearly say: <strong>“Mayday, Mayday, Mayday”</strong></li>
      <li>Follow with:
        <ul>
          <li>Your <strong>boat name</strong></li>
          <li>Your <strong>position</strong> (GPS or landmark)</li>
          <li><strong>Nature of emergency</strong></li>
          <li><strong>Number of people</strong> on board</li>
          <li>What <strong>assistance</strong> you need</li>
          <li>Any visible signals (flares, flags)</li>
        </ul>
      </li>
    </ol>

    <p><em><strong>Example:</strong></em><br>
      “Mayday, Mayday, Mayday. This is sailboat <em>Dragonfly</em>.<br>
      We are taking on water near Crystal Bay. Position approximately 45.41° N, 75.76° W.<br>
      Three people on board. Request immediate assistance. We are launching red flares.”
    </p>

    <h4>📱 Cell Phone Backup</h4>
    <ul>
      <li>Dial <strong>911</strong> and state you are in a <strong>marine emergency</strong></li>
      <li>Ask dispatch to contact <strong>JRCC Trenton</strong></li>
      <li>Give your location, boat details, and emergency info</li>
    </ul>

    <h4>🚨 Emergency Numbers</h4>
    <ul>
      <li>📞 <strong>911</strong> (from cell, near shore)</li>
      <li>📞 <strong>JRCC Trenton (24/7):</strong><br>
        Toll-free: <strong>1-800-267-7270</strong><br>
        Alternate: <strong>1-613-965-3870</strong>
      </li>
    </ul>

    <h4>🧨 Emergency Signaling Options</h4>
    <ul>
      <li>Red flares (day/night)</li>
      <li>Orange smoke (day)</li>
      <li>Mirror or flashlight signals</li>
      <li>Continuous horn blast</li>
      </ul>
    </div>
    
    <div style="padding: 1em;">
    <h2>Other Links</h2>
    <ul>
      <li><a href="https://nsc.ca/an/boating/know-how/nsc-marine-emergency-procedures/" target="_blank">NSC Marine Emergency Procedures</a></li>
    </ul>
    </div>
</div>

  </section>

  <!-- App JS -->
  <script type="module" src="app.js"></script>
</body>
</html>
